<!DOCTYPE html>
<meta charset="utf-8">
<head>
  <title>Geo interpolator</title>
</head>

<style>
body {
  font-family: "Helvetica Neue", Helvetica, sans-serif;
  font-size: 14px;
  color: #333;
}
.arcs {
  opacity:.1;
  stroke: gray;
  stroke-width: 3;
}
.flyers {
  stroke-width:1;
  opacity: .6;
  stroke: darkred;
}
.arc, .flyer {
  stroke-linejoin: round;
  fill:none;
}
  .arc { }
  .flyer { }
  .flyer:hover { }

</style>

<body>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.2/d3.min.js"></script>

  <script>
var geojson = {}
var width = 960,
    height = 500;
var sens = 0.25;

var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height)
            .on("mousedown", mousedown);
queue()
  .defer(d3.json, "graph.json")
  .await(ready);

function ready(error, graph){

}

var projection = d3.geoOrthographic()
  .scale(220)

var sky = d3.geoOrthographic()
    .translate([width / 2, height / 2])
    .clipAngle(90)
    .scale(300);

var path = d3.geoPath().projection(projection).pointRadius(2);

var swoosh = d3.line()
      .x(function(d) { return d[0] })
      .y(function(d) { return d[1] })
      .curve(d3.curveCardinal)
      .context(context)

var swooshSVG = d3.line()
      .x(function(d) { return d[0] })
      .y(function(d) { return d[1] })
      .curve(d3.curveCardinal)
      // .tension(.0);

function flying_arc(pts) {
  var source = pts[0],
      target = pts[1];

  var mid = location_along_arc(source, target, .5);
  var result = [ projection(source),
                 sky(mid),
                 projection(target) ]
  return result;
}

function fade_at_edge(d) {
  var centerPos = projection.invert([width/2,height/2]),
      arc = d3.geo.greatArc(),
      start, end;
  // function is called on 2 different data structures..
  if (d[0]) {
    start = d[0],
    end = d[0];
  }
  else {
    start = d.geometry.coordinates[0];
    end = d.geometry.coordinates[1];
  }

  var start_dist = 1.57 - arc.distance({source: start, target: centerPos}),
      end_dist = 1.57 - arc.distance({source: end, target: centerPos});

  var fade = d3.scale.linear().domain([-.1,0]).range([0,.1])
  var dist = start_dist < end_dist ? start_dist : end_dist;

  return fade(dist)
}

var geoGenerator = d3.geoPath()
  .projection(projection)
  .pointRadius(4)
  .context(context);


var londonLonLat = [0.1278, 51.5074];
var newYorkLonLat = [-74.0059, 40.7128];
var geoInterpolator = d3.geoInterpolate(londonLonLat, newYorkLonLat);
var u = 0;
var yaw = 300;
var link = [londonLonLat, newYorkLonLat];
var links = [link],
    arcLines = [];
//   {
//     source: londonLonLat,
//     target: newYorkLonLat
//   }
// ]
// links.forEach(function(e,i,a) {
//   var feature =   { "type": "Feature", "geometry": { "type": "LineString", "coordinates": [e.source,e.target] }}
//   arcLines.push(feature)
// })

function location_along_arc(start, end, loc) {
  var interpolator = d3.geoInterpolate(start,end);
  return interpolator(loc)
}




var m0;
var o0;
var done;

d3.select("#content canvas").call(d3.drag()
  .subject(function() { var r = projection.rotate(); return {x: r[0] / sens, y: -r[1] / sens}; })
  .on("drag", function() {
    var rotate = projection.rotate();
    var skyRotate = sky.rotate();
    projection.rotate([d3.event.x * sens, -d3.event.y * sens, projection.rotate()[2]]);
    sky.rotate([d3.event.x * sens, -d3.event.y * sens, sky.rotate()[2]]);

  }))


function update() {
  var pathEl = d3.select("body")
    .append("svg")
    .append("path")
    .attr("d", swooshSVG(flying_arc(link)));
  var length = pathEl.node().getTotalLength();
  d3.select("svg").remove;
  // var links = [
  //   geoInterpolate
  // // ]
  // var arcLines = [
  //   { "type": "Feature", "geometry": { "type": "LineString", "coordinates": [londonLonLat,newYorkLonLat] }}
  // ];

  // projection.rotate([yaw, -45])
  // sky.rotate([yaw, -45])
  context.clearRect(0, 0, 800, 600);

  context.lineWidth = 0.5;
  context.setLineDash([])
  context.strokeStyle = '#333';

  context.beginPath();
  geoGenerator({type: 'FeatureCollection', features: geojson.features})
  context.stroke();

  // Graticule
  var graticule = d3.geoGraticule();
  context.beginPath();
  context.strokeStyle = '#ccc';
  geoGenerator(graticule());
  context.stroke();
  //
  // d3.select('#content canvas')
  //   .append("g").attr("class","arcs")
  //   .selectAll("path").data(arcLines)
  //   .enter().append("path")
  //     .attr("class","arc")
  //     .attr("d",path)
  //
  // d3.select('#content canvas')
  //   .append("g").attr("class","flyers")
  //   .selectAll("path").data(links)
  //   .enter().append("path")
  //   .attr("class","flyer")
  //   .attr("d", function(d) { return swoosh(flying_arc(d)) })

    // London - New York
    context.beginPath();
    context.strokeStyle = 'red';
    context.setLineDash([length])
    context.lineDashOffset = length*(1-u);
    swoosh(flying_arc(link))
    context.stroke();

    context.beginPath();
    context.fillStyle = 'red';
    geoGenerator({type: 'Feature', geometry: {type: 'Point', coordinates: link[0]}});
    context.fill();

    context.beginPath();
    context.fillStyle = 'red';
    geoGenerator({type: 'Feature', geometry: {type: 'Point', coordinates: link[1]}});
    context.fill();


  u += 0.02
  if(u > 1) u = 1
  yaw -= 0.3
}



// REQUEST DATA
d3.json('https://gist.githubusercontent.com/d3indepth/f28e1c3a99ea6d84986f35ac8646fac7/raw/c58cede8dab4673c91a3db702d50f7447b373d98/ne_110m_land.json', function(err, json) {
  geojson = json;
  window.setInterval(update, 50);
  // update(json);
})

  </script>
</body>
</html>
